{"version":3,"sources":["../src/context/request-context.ts","../src/middleware.ts","../src/edge.ts","../src/index.ts"],"names":["init","coreFlush","setUserContext"],"mappings":";;;;;;;AAoCA,IAAM,qBAAA,GAAwB,IAAI,iBAAA,EAAkC;AAK7D,SAAS,cAAA,CACd,SACA,EAAA,EACG;AACH,EAAA,OAAO,qBAAA,CAAsB,GAAA,CAAI,OAAA,EAAS,EAAE,CAAA;AAC9C;AAKO,SAAS,iBAAA,GAAgD;AAC9D,EAAA,OAAO,sBAAsB,QAAA,EAAS;AACxC;AAKO,SAAS,qBAAA,GAA4C;AAC1D,EAAA,MAAM,UAAU,iBAAA,EAAkB;AAClC,EAAA,OAAO,SAAS,WAAA,IAAe,IAAA;AACjC;AAKO,SAAS,sBAAsB,WAAA,EAAuC;AAC3E,EAAA,MAAM,UAAU,iBAAA,EAAkB;AAClC,EAAA,IAAI,OAAA,EAAS;AACX,IAAA,OAAA,CAAQ,WAAA,GAAc,WAAA;AAAA,EACxB;AACF;AAKO,SAAS,iBAAA,GAA4B;AAC1C,EAAA,OAAO,OAAO,IAAA,CAAK,GAAA,EAAI,CAAE,QAAA,CAAS,EAAE,CAAC,CAAA,CAAA,EAAI,IAAA,CAAK,MAAA,GAAS,QAAA,CAAS,EAAE,EAAE,SAAA,CAAU,CAAA,EAAG,CAAC,CAAC,CAAA,CAAA;AACrF;AAKO,SAAS,oBAAA,CACd,WAAA,GAAkC,IAAA,EAClC,QAAA,EACgB;AAChB,EAAA,OAAO;AAAA,IACL,WAAA;AAAA,IACA,WAAW,iBAAA,EAAkB;AAAA,IAC7B,SAAA,EAAW,KAAK,GAAA,EAAI;AAAA,IACpB;AAAA,GACF;AACF;AChDO,IAAM,mBAAA,GAAsB;AAMnC,eAAe,sBAAsB,OAAA,EAAmD;AAEtF,EAAA,MAAM,MAAA,GACJ,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,WAAW,KAC/B,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,sBAAsB,CAAA,IAC1C,IAAA;AAGF,EAAA,MAAM,kBAAA,GAAqB,QAAQ,OAAA,CAAQ,GAAA,CAAI,yBAAyB,CAAA,IACtE,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,kCAAkC,CAAA;AAGxD,EAAA,MAAM,eAAA,GAAkB,QAAQ,OAAA,CAAQ,GAAA,CAAI,WAAW,CAAA,IACrD,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,gBAAgB,CAAA;AAGtC,EAAA,MAAM,aAAA,GAAgB,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,eAAe,CAAA;AAGzD,EAAA,IAAI,OAAA,GAAkC,WAAA;AACtC,EAAA,IAAI,MAAA,IAAU,kBAAA,IAAsB,eAAA,IAAmB,aAAA,EAAe;AACpE,IAAA,OAAA,GAAU,eAAA;AAAA,EACZ;AAGA,EAAA,MAAM,UAAA,GAAa,OAAA,CAAQ,OAAA,CAAQ,QAAA,CAAS,WAAW,MAAM,CAAA;AAC7D,EAAA,IAAI,cAAc,aAAA,EAAe;AAC/B,IAAA,OAAA,GAAU,KAAA;AAAA,EACZ;AAEA,EAAA,OAAO;AAAA,IACL,MAAA,EAAQ,MAAA,GAAS,MAAA,CAAO,MAAM,CAAA,GAAI,IAAA;AAAA,IAClC,OAAA;AAAA,IACA,QAAA,EAAU;AAAA,MACR,IAAA,EAAM,QAAQ,OAAA,CAAQ,QAAA;AAAA,MACtB,QAAQ,OAAA,CAAQ;AAAA;AAClB,GACF;AACF;AAKO,SAAS,cAAA,CACd,UAAA,EACA,OAAA,GAAiC,EAAC,EACe;AACjD,EAAA,MAAM,EAAE,cAAA,GAAiB,qBAAA,EAAuB,eAAA,GAAkB,IAAG,GAAI,OAAA;AAEzE,EAAA,OAAO,eAAe,qBAAqB,OAAA,EAA6C;AACtF,IAAA,MAAM,GAAA,GAAM,QAAQ,OAAA,CAAQ,QAAA;AAG5B,IAAA,KAAA,MAAW,WAAW,eAAA,EAAiB;AACrC,MAAA,IAAI,OAAO,OAAA,KAAY,QAAA,IAAY,GAAA,CAAI,QAAA,CAAS,OAAO,CAAA,EAAG;AACxD,QAAA,OAAO,WAAW,OAAO,CAAA;AAAA,MAC3B;AACA,MAAA,IAAI,OAAA,YAAmB,MAAA,IAAU,OAAA,CAAQ,IAAA,CAAK,GAAG,CAAA,EAAG;AAClD,QAAA,OAAO,WAAW,OAAO,CAAA;AAAA,MAC3B;AAAA,IACF;AAGA,IAAA,MAAM,WAAA,GAAc,MAAM,cAAA,CAAe,OAAO,CAAA;AAGhD,IAAA,MAAM,QAAA,GAAW,MAAM,UAAA,CAAW,OAAO,CAAA;AAGzC,IAAA,IAAI,WAAA,EAAa;AACf,MAAA,MAAM,aAAA,GAAgB,IAAA,CAAK,SAAA,CAAU,WAAW,CAAA;AAChD,MAAA,QAAA,CAAS,OAAA,CAAQ,GAAA,CAAI,mBAAA,EAAqB,aAAa,CAAA;AAAA,IACzD;AAEA,IAAA,OAAO,QAAA;AAAA,EACT,CAAA;AACF;AAKO,SAAS,0BAA0B,OAAA,EAAsC;AAC9E,EAAA,MAAM,aAAA,GAAgB,OAAA,CAAQ,OAAA,CAAQ,GAAA,CAAI,mBAAmB,CAAA;AAC7D,EAAA,IAAI,CAAC,eAAe,OAAO,IAAA;AAE3B,EAAA,IAAI;AACF,IAAA,OAAO,IAAA,CAAK,MAAM,aAAa,CAAA;AAAA,EACjC,CAAA,CAAA,MAAQ;AACN,IAAA,OAAO,IAAA;AAAA,EACT;AACF;AAMO,SAAS,0BAAA,CACd,OAAA,GAAiC,EAAC,EACe;AACjD,EAAA,OAAO,cAAA;AAAA,IACL,MAAM,aAAa,IAAA,EAAK;AAAA,IACxB;AAAA,GACF;AACF;ACjIA,IAAI,aAAA,GAAgB,KAAA;AAKpB,SAAS,iBAAA,GAA6B;AACpC,EAAA,IAAI,aAAA,IAAiB,WAAU,EAAG;AAChC,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,MAAM,MAAA,GAAS,QAAQ,GAAA,CAAI,kBAAA;AAC3B,EAAA,MAAM,QAAA,GAAW,QAAQ,GAAA,CAAI,mBAAA;AAE7B,EAAA,IAAI,CAAC,MAAA,EAAQ;AACX,IAAA,OAAA,CAAQ,KAAK,8DAA8D,CAAA;AAC3E,IAAA,OAAO,KAAA;AAAA,EACT;AAEA,EAAA,IAAA,CAAK;AAAA,IACH,MAAA;AAAA,IACA,QAAA;AAAA,IACA,KAAA,EAAO,OAAA,CAAQ,GAAA,CAAI,gBAAA,KAAqB,MAAA;AAAA,IACxC,SAAA,EAAW,CAAA;AAAA;AAAA,IACX,aAAA,EAAe;AAAA,GAChB,CAAA;AAED,EAAA,aAAA,GAAgB,IAAA;AAChB,EAAA,OAAA,CAAQ,IAAI,8CAA8C,CAAA;AAC1D,EAAA,OAAO,IAAA;AACT;AAMO,SAAS,SAAS,MAAA,EAA0C;AACjE,EAAA,IAAI,aAAA,EAAe;AAEnB,EAAA,MAAM,MAAA,GAAS,MAAA,EAAQ,MAAA,IAAU,OAAA,CAAQ,GAAA,CAAI,kBAAA;AAE7C,EAAA,IAAI,CAAC,MAAA,EAAQ;AACX,IAAA,OAAA,CAAQ,KAAK,+CAA+C,CAAA;AAC5D,IAAA;AAAA,EACF;AAEA,EAAA,IAAA,CAAK;AAAA,IACH,MAAA;AAAA,IACA,QAAA,EAAU,MAAA,EAAQ,QAAA,IAAY,OAAA,CAAQ,GAAA,CAAI,mBAAA;AAAA,IAC1C,KAAA,EAAO,MAAA,EAAQ,KAAA,IAAS,OAAA,CAAQ,IAAI,gBAAA,KAAqB,MAAA;AAAA;AAAA,IAEzD,SAAA,EAAW,QAAQ,SAAA,IAAa,CAAA;AAAA,IAChC,aAAA,EAAe,QAAQ,aAAA,IAAiB,GAAA;AAAA,IACxC,GAAG;AAAA,GACJ,CAAA;AAED,EAAA,aAAA,GAAgB,IAAA;AAClB;AAMA,eAAsB,UAAA,CACpB,OACAA,KAAAA,EACmB;AAEnB,EAAA,MAAM,cAAc,iBAAA,EAAkB;AAEtC,EAAA,MAAM,SAAA,GAAY,YAAY,GAAA,EAAI;AAClC,EAAA,MAAM,GAAA,GAAM,OAAO,KAAA,KAAU,QAAA,GAAW,KAAA,GAAQ,iBAAiB,GAAA,GAAM,KAAA,CAAM,QAAA,EAAS,GAAI,KAAA,CAAM,GAAA;AAChG,EAAA,MAAM,MAAA,GAASA,OAAM,MAAA,IAAU,KAAA;AAC/B,EAAA,MAAM,cAAcA,KAAAA,EAAM,WAAA;AAG1B,EAAA,MAAM,SAAA,GAAYA,KAAAA,GAAO,EAAE,GAAGA,OAAK,GAAI,MAAA;AACvC,EAAA,IAAI,SAAA,EAAW;AACb,IAAA,OAAQ,SAAA,CAAkB,WAAA;AAAA,EAC5B;AAEA,EAAA,IAAI;AACF,IAAA,MAAM,QAAA,GAAW,MAAM,KAAA,CAAM,KAAA,EAAO,SAAS,CAAA;AAC7C,IAAA,MAAM,QAAA,GAAW,WAAA,CAAY,GAAA,EAAI,GAAI,SAAA;AAGrC,IAAA,IAAI,WAAA,EAAa;AACf,MAAA,KAAA,CAAM;AAAA,QACJ,MAAA,EAAQ,OAAO,WAAA,EAAY;AAAA,QAC3B,GAAA;AAAA,QACA,YAAY,QAAA,CAAS,MAAA;AAAA,QACrB,QAAA;AAAA,QACA,aAAa,WAAA,IAAe;AAAA,OAC7B,CAAA;AAGD,MAAA,MAAMC,KAAA,EAAU;AAAA,IAClB;AAEA,IAAA,OAAO,QAAA;AAAA,EACT,SAAS,KAAA,EAAO;AACd,IAAA,MAAM,QAAA,GAAW,WAAA,CAAY,GAAA,EAAI,GAAI,SAAA;AAErC,IAAA,IAAI,WAAA,EAAa;AACf,MAAA,KAAA,CAAM;AAAA,QACJ,MAAA,EAAQ,OAAO,WAAA,EAAY;AAAA,QAC3B,GAAA;AAAA,QACA,UAAA,EAAY,CAAA;AAAA,QACZ,QAAA;AAAA,QACA,KAAA,EAAO,KAAA,YAAiB,KAAA,GAAQ,KAAA,CAAM,OAAA,GAAU,eAAA;AAAA,QAChD,aAAa,WAAA,IAAe;AAAA,OAC7B,CAAA;AAED,MAAA,MAAMA,KAAA,EAAU;AAAA,IAClB;AAEA,IAAA,MAAM,KAAA;AAAA,EACR;AACF;AAKO,SAAS,mBAAmB,WAAA,EAA0B;AAC3D,EAAA,OAAO,eAAe,YAAA,CACpB,KAAA,EACAD,KAAAA,EACmB;AACnB,IAAA,OAAO,WAAW,KAAA,EAAO,EAAE,GAAGA,KAAAA,EAAM,aAAa,CAAA;AAAA,EACnD,CAAA;AACF;AA4FA,SAAS,UAAA,GAAqB;AAE5B,EAAA,MAAM,QAAA,GAAW,OAAA,CAAQ,GAAA,CAAI,mBAAA,IAAuB,yCAAA;AAGpD,EAAA,OAAO,QAAA,CAAS,OAAA,CAAQ,SAAA,EAAW,EAAE,CAAA;AACvC;AAkBA,eAAsB,SAAA,CACpB,WAAA,EACA,OAAA,GAA4B,EAAC,EACM;AACnC,EAAA,MAAM,MAAA,GAAS,QAAQ,GAAA,CAAI,kBAAA;AAC3B,EAAA,IAAI,CAAC,MAAA,EAAQ;AACX,IAAA,OAAA,CAAQ,KAAK,8CAA8C,CAAA;AAC3D,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,IAAI;AACF,IAAA,MAAM,MAAM,CAAA,EAAG,UAAA,EAAY,CAAA,cAAA,EAAiB,kBAAA,CAAmB,WAAW,CAAC,CAAA,CAAA;AAC3E,IAAA,MAAM,SAAA,GAAY,OAAA,CAAQ,SAAA,IAAa,MAAA,CAAO,UAAA,EAAW;AAEzD,IAAA,MAAM,OAAA,GAAkC;AAAA,MACtC,eAAA,EAAiB,UAAU,MAAM,CAAA,CAAA;AAAA,MACjC,QAAA,EAAU,kBAAA;AAAA,MACV,cAAA,EAAgB;AAAA,KAClB;AAEA,IAAA,IAAI,QAAQ,WAAA,EAAa;AACvB,MAAA,OAAA,CAAQ,gBAAgB,CAAA,GAAI,IAAA,CAAK,SAAA,CAAU,QAAQ,WAAW,CAAA;AAAA,IAChE;AAEA,IAAA,MAAM,QAAA,GAAW,MAAM,KAAA,CAAM,GAAA,EAAK;AAAA,MAChC,MAAA,EAAQ,KAAA;AAAA,MACR;AAAA,KACD,CAAA;AAED,IAAA,OAAO,MAAM,SAAS,IAAA,EAAK;AAAA,EAC7B,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,oCAAoC,KAAK,CAAA;AACvD,IAAA,OAAO,IAAA;AAAA,EACT;AACF;AAkBA,eAAsB,cAAA,CACpB,YAAA,EACA,OAAA,GAA4B,EAAC,EACW;AACxC,EAAA,MAAM,MAAA,GAAS,QAAQ,GAAA,CAAI,kBAAA;AAC3B,EAAA,IAAI,CAAC,MAAA,EAAQ;AACX,IAAA,OAAA,CAAQ,KAAK,mDAAmD,CAAA;AAChE,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,IAAI;AACF,IAAA,MAAM,MAAM,CAAA,EAAG,UAAA,EAAY,CAAA,aAAA,EAAgB,kBAAA,CAAmB,YAAY,CAAC,CAAA,OAAA,CAAA;AAE3E,IAAA,MAAM,OAAA,GAAkC;AAAA,MACtC,eAAA,EAAiB,UAAU,MAAM,CAAA,CAAA;AAAA,MACjC,QAAA,EAAU;AAAA,KACZ;AAEA,IAAA,IAAI,QAAQ,WAAA,EAAa;AACvB,MAAA,OAAA,CAAQ,gBAAgB,CAAA,GAAI,IAAA,CAAK,SAAA,CAAU,QAAQ,WAAW,CAAA;AAAA,IAChE;AAEA,IAAA,MAAM,QAAA,GAAW,MAAM,KAAA,CAAM,GAAA,EAAK;AAAA,MAChC,MAAA,EAAQ,KAAA;AAAA,MACR;AAAA,KACD,CAAA;AAED,IAAA,OAAO,MAAM,SAAS,IAAA,EAAK;AAAA,EAC7B,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,yCAAyC,KAAK,CAAA;AAC5D,IAAA,OAAO,IAAA;AAAA,EACT;AACF;AAkBA,eAAsB,cAAA,CACpB,YAAA,EACA,OAAA,GAA4B,EAAC,EACW;AACxC,EAAA,MAAM,MAAA,GAAS,QAAQ,GAAA,CAAI,kBAAA;AAC3B,EAAA,IAAI,CAAC,MAAA,EAAQ;AACX,IAAA,OAAA,CAAQ,KAAK,mDAAmD,CAAA;AAChE,IAAA,OAAO,IAAA;AAAA,EACT;AAEA,EAAA,IAAI;AACF,IAAA,MAAM,MAAM,CAAA,EAAG,UAAA,EAAY,CAAA,aAAA,EAAgB,kBAAA,CAAmB,YAAY,CAAC,CAAA,OAAA,CAAA;AAE3E,IAAA,MAAM,OAAA,GAAkC;AAAA,MACtC,eAAA,EAAiB,UAAU,MAAM,CAAA,CAAA;AAAA,MACjC,QAAA,EAAU;AAAA,KACZ;AAEA,IAAA,IAAI,QAAQ,WAAA,EAAa;AACvB,MAAA,OAAA,CAAQ,gBAAgB,CAAA,GAAI,IAAA,CAAK,SAAA,CAAU,QAAQ,WAAW,CAAA;AAAA,IAChE;AAEA,IAAA,MAAM,QAAA,GAAW,MAAM,KAAA,CAAM,GAAA,EAAK;AAAA,MAChC,MAAA,EAAQ,KAAA;AAAA,MACR;AAAA,KACD,CAAA;AAED,IAAA,OAAO,MAAM,SAAS,IAAA,EAAK;AAAA,EAC7B,SAAS,KAAA,EAAO;AACd,IAAA,OAAA,CAAQ,KAAA,CAAM,yCAAyC,KAAK,CAAA;AAC5D,IAAA,OAAO,IAAA;AAAA,EACT;AACF;AA8EO,SAAS,gBAAA,CACd,eACA,OAAA,EACM;AAEN,EAAA,iBAAA,EAAkB;AAGlB,EAAA,aAAA,CAAc,aAAa,OAAA,CAAQ,GAAA;AAAA,IACjC,CAAC,MAAA,KAAgB;AACf,MAAA,MAAA,CAAO,QAAA,GAAW,EAAE,SAAA,EAAW,WAAA,CAAY,KAAI,EAAE;AACjD,MAAA,OAAO,MAAA;AAAA,IACT,CAAA;AAAA,IACA,CAAC,KAAA,KAAe,OAAA,CAAQ,MAAA,CAAO,KAAK;AAAA,GACtC;AAGA,EAAA,aAAA,CAAc,aAAa,QAAA,CAAS,GAAA;AAAA,IAClC,OAAO,QAAA,KAA4B;AACjC,MAAA,MAAM,QAAA,GAAW,QAAA,CAAS,MAAA,CAAO,QAAA,EAAU,SAAA,GACvC,WAAA,CAAY,GAAA,EAAI,GAAI,QAAA,CAAS,MAAA,CAAO,QAAA,CAAS,SAAA,GAC7C,CAAA;AAEJ,MAAA,MAAM,GAAA,GAAM,aAAA,CAAc,QAAA,CAAS,MAAM,CAAA;AAEzC,MAAA,KAAA,CAAM;AAAA,QACJ,MAAA,EAAA,CAAS,QAAA,CAAS,MAAA,CAAO,MAAA,IAAU,OAAO,WAAA,EAAY;AAAA,QACtD,GAAA;AAAA,QACA,YAAY,QAAA,CAAS,MAAA;AAAA,QACrB,QAAA;AAAA,QACA,WAAA,EAAa,SAAS,WAAA,IAAe;AAAA,OACtC,CAAA;AAGD,MAAA,MAAMC,KAAA,EAAU;AAEhB,MAAA,OAAO,QAAA;AAAA,IACT,CAAA;AAAA,IACA,OAAO,KAAA,KAAsB;AAC3B,MAAA,MAAM,QAAA,GAAW,KAAA,CAAM,MAAA,EAAQ,QAAA,EAAU,SAAA,GACrC,WAAA,CAAY,GAAA,EAAI,GAAI,KAAA,CAAM,MAAA,CAAO,QAAA,CAAS,SAAA,GAC1C,CAAA;AAEJ,MAAA,MAAM,MAAM,KAAA,CAAM,MAAA,GAAS,aAAA,CAAc,KAAA,CAAM,MAAM,CAAA,GAAI,SAAA;AAEzD,MAAA,KAAA,CAAM;AAAA,QACJ,MAAA,EAAA,CAAS,KAAA,CAAM,MAAA,EAAQ,MAAA,IAAU,OAAO,WAAA,EAAY;AAAA,QACpD,GAAA;AAAA,QACA,UAAA,EAAY,KAAA,CAAM,QAAA,EAAU,MAAA,IAAU,CAAA;AAAA,QACtC,QAAA;AAAA,QACA,OAAO,KAAA,CAAM,OAAA;AAAA,QACb,WAAA,EAAa,SAAS,WAAA,IAAe;AAAA,OACtC,CAAA;AAED,MAAA,MAAMA,KAAA,EAAU;AAEhB,MAAA,OAAO,OAAA,CAAQ,OAAO,KAAK,CAAA;AAAA,IAC7B;AAAA,GACF;AACF;AAKA,SAAS,cAAc,MAAA,EAAyC;AAC9D,EAAA,MAAM,OAAA,GAAU,OAAO,OAAA,IAAW,EAAA;AAClC,EAAA,MAAM,GAAA,GAAM,OAAO,GAAA,IAAO,EAAA;AAE1B,EAAA,IAAI,IAAI,UAAA,CAAW,SAAS,KAAK,GAAA,CAAI,UAAA,CAAW,UAAU,CAAA,EAAG;AAC3D,IAAA,OAAO,GAAA;AAAA,EACT;AAEA,EAAA,OAAO,OAAA,GAAU,GAAA;AACnB;AAiBO,SAAS,kBAAA,CACd,KAAA,EACA,MAAA,EACA,OAAA,EACe;AACf,EAAA,MAAM,QAAA,GAAW,KAAA,CAAM,MAAA,CAAO,MAAM,CAAA;AACpC,EAAA,gBAAA,CAAiB,UAAU,OAAO,CAAA;AAClC,EAAA,OAAO,QAAA;AACT;;;ACneO,SAAS,eAAA,CACd,SACA,WAAA,EACG;AACH,EAAA,QAAQ,UAAU,IAAA,KAAwB;AACxC,IAAA,MAAM,EAAE,cAAA,EAAAC,eAAAA,EAAe,GAAI,MAAM,OAAO,kBAAkB,CAAA;AAC1D,IAAAA,gBAAe,WAAW,CAAA;AAC1B,IAAA,IAAI;AACF,MAAA,OAAO,MAAM,OAAA,CAAQ,GAAG,IAAI,CAAA;AAAA,IAC9B,CAAA,SAAE;AACA,MAAAA,gBAAe,IAAI,CAAA;AAAA,IACrB;AAAA,EACF,CAAA;AACF","file":"index.mjs","sourcesContent":["/**\n * Request context using AsyncLocalStorage\n * \n * This allows us to track user context across the entire request lifecycle,\n * similar to how Laravel uses request context for Auth::user().\n */\n\nimport { AsyncLocalStorage } from 'async_hooks';\nimport type { UserContext } from '@outboundiq/core';\n\n/**\n * Request context stored for each request\n */\nexport interface RequestContext {\n  /**\n   * User context for this request\n   */\n  userContext: UserContext | null;\n\n  /**\n   * Request ID for tracing\n   */\n  requestId: string;\n\n  /**\n   * Request start time\n   */\n  startTime: number;\n\n  /**\n   * Additional metadata\n   */\n  metadata?: Record<string, unknown>;\n}\n\n// Create the AsyncLocalStorage instance\nconst requestContextStorage = new AsyncLocalStorage<RequestContext>();\n\n/**\n * Run a function with request context\n */\nexport function runWithContext<T>(\n  context: RequestContext,\n  fn: () => T\n): T {\n  return requestContextStorage.run(context, fn);\n}\n\n/**\n * Get the current request context\n */\nexport function getRequestContext(): RequestContext | undefined {\n  return requestContextStorage.getStore();\n}\n\n/**\n * Get the current user context\n */\nexport function getCurrentUserContext(): UserContext | null {\n  const context = getRequestContext();\n  return context?.userContext ?? null;\n}\n\n/**\n * Set user context for the current request\n */\nexport function setCurrentUserContext(userContext: UserContext | null): void {\n  const context = getRequestContext();\n  if (context) {\n    context.userContext = userContext;\n  }\n}\n\n/**\n * Generate a request ID\n */\nexport function generateRequestId(): string {\n  return `req_${Date.now().toString(36)}_${Math.random().toString(36).substring(2, 9)}`;\n}\n\n/**\n * Create a new request context\n */\nexport function createRequestContext(\n  userContext: UserContext | null = null,\n  metadata?: Record<string, unknown>\n): RequestContext {\n  return {\n    userContext,\n    requestId: generateRequestId(),\n    startTime: Date.now(),\n    metadata,\n  };\n}\n\n","/**\n * @outboundiq/nextjs/middleware\n * \n * Middleware utilities for user context injection\n * \n * @example\n * ```typescript\n * // middleware.ts\n * import { withOutboundIQ } from '@outboundiq/nextjs/middleware';\n * import { getToken } from 'next-auth/jwt';\n * \n * export default withOutboundIQ(async (request) => {\n *   // Your middleware logic\n *   return NextResponse.next();\n * }, {\n *   // Optional: custom user resolver\n *   getUserContext: async (request) => {\n *     const token = await getToken({ req: request });\n *     return token ? { userId: token.sub, context: 'authenticated' } : null;\n *   }\n * });\n * ```\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport type { UserContext } from '@outboundiq/core';\n\n/**\n * Options for the OutboundIQ middleware wrapper\n */\nexport interface WithOutboundIQOptions {\n  /**\n   * Custom function to extract user context from the request\n   */\n  getUserContext?: (request: NextRequest) => Promise<UserContext | null> | UserContext | null;\n\n  /**\n   * Patterns to exclude from tracking\n   */\n  excludePatterns?: (string | RegExp)[];\n}\n\n/**\n * Header name for passing user context to API routes\n */\nexport const USER_CONTEXT_HEADER = 'x-outboundiq-user-context';\n\n/**\n * Default user context resolver\n * Attempts to extract user info from common patterns\n */\nasync function defaultGetUserContext(request: NextRequest): Promise<UserContext | null> {\n  // Try to get user ID from common header patterns\n  const userId = \n    request.headers.get('x-user-id') ||\n    request.headers.get('x-authenticated-user') ||\n    null;\n\n  // Check for NextAuth session cookie\n  const hasNextAuthSession = request.cookies.has('next-auth.session-token') ||\n    request.cookies.has('__Secure-next-auth.session-token');\n\n  // Check for Clerk session\n  const hasClerkSession = request.cookies.has('__session') ||\n    request.cookies.has('__clerk_db_jwt');\n\n  // Check for Authorization header\n  const hasAuthHeader = request.headers.has('authorization');\n\n  // Determine context type\n  let context: UserContext['context'] = 'anonymous';\n  if (userId || hasNextAuthSession || hasClerkSession || hasAuthHeader) {\n    context = 'authenticated';\n  }\n\n  // Check if it's an API call vs page request\n  const isApiRoute = request.nextUrl.pathname.startsWith('/api');\n  if (isApiRoute && hasAuthHeader) {\n    context = 'api';\n  }\n\n  return {\n    userId: userId ? String(userId) : null,\n    context,\n    metadata: {\n      path: request.nextUrl.pathname,\n      method: request.method,\n    },\n  };\n}\n\n/**\n * Wrap your middleware with OutboundIQ user context injection\n */\nexport function withOutboundIQ(\n  middleware: (request: NextRequest) => Promise<NextResponse> | NextResponse,\n  options: WithOutboundIQOptions = {}\n): (request: NextRequest) => Promise<NextResponse> {\n  const { getUserContext = defaultGetUserContext, excludePatterns = [] } = options;\n\n  return async function outboundIQMiddleware(request: NextRequest): Promise<NextResponse> {\n    const url = request.nextUrl.pathname;\n\n    // Check exclusions\n    for (const pattern of excludePatterns) {\n      if (typeof pattern === 'string' && url.includes(pattern)) {\n        return middleware(request);\n      }\n      if (pattern instanceof RegExp && pattern.test(url)) {\n        return middleware(request);\n      }\n    }\n\n    // Get user context\n    const userContext = await getUserContext(request);\n\n    // Call the original middleware\n    const response = await middleware(request);\n\n    // Inject user context header for downstream API routes\n    if (userContext) {\n      const contextHeader = JSON.stringify(userContext);\n      response.headers.set(USER_CONTEXT_HEADER, contextHeader);\n    }\n\n    return response;\n  };\n}\n\n/**\n * Extract user context from request headers (for API routes)\n */\nexport function getUserContextFromRequest(request: Request): UserContext | null {\n  const contextHeader = request.headers.get(USER_CONTEXT_HEADER);\n  if (!contextHeader) return null;\n\n  try {\n    return JSON.parse(contextHeader) as UserContext;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Create a simple middleware that just injects user context\n * Use this if you don't have existing middleware\n */\nexport function createOutboundIQMiddleware(\n  options: WithOutboundIQOptions = {}\n): (request: NextRequest) => Promise<NextResponse> {\n  return withOutboundIQ(\n    () => NextResponse.next(),\n    options\n  );\n}\n\n","/**\n * @outboundiq/nextjs/edge\n * \n * Edge runtime support for Next.js middleware and edge API routes\n * \n * @example\n * ```typescript\n * // In Edge API route or middleware\n * import { trackFetch } from '@outboundiq/nextjs/edge';\n * \n * export const runtime = 'edge';\n * \n * export async function GET(request: Request) {\n *   // Manually track a fetch in edge runtime\n *   const response = await trackFetch('https://api.example.com/data', {\n *     method: 'GET',\n *   });\n *   \n *   return Response.json(await response.json());\n * }\n * ```\n */\n\nimport { init, track, getClient, flush as coreFlush, type OutboundIQConfig, type UserContext } from '@outboundiq/core';\n\nlet isInitialized = false;\n\n/**\n * Ensure SDK is initialized\n */\nfunction ensureInitialized(): boolean {\n  if (isInitialized || getClient()) {\n    return true;\n  }\n\n  const apiKey = process.env.OUTBOUNDIQ_API_KEY;\n  const endpoint = process.env.OUTBOUNDIQ_ENDPOINT;\n\n  if (!apiKey) {\n    console.warn('[OutboundIQ] Missing OUTBOUNDIQ_API_KEY environment variable');\n    return false;\n  }\n\n  init({\n    apiKey,\n    endpoint,\n    debug: process.env.OUTBOUNDIQ_DEBUG === 'true',\n    batchSize: 1, // Send immediately for serverless\n    flushInterval: 1000,\n  });\n\n  isInitialized = true;\n  console.log('[OutboundIQ] Auto-initialized for trackFetch');\n  return true;\n}\n\n/**\n * Initialize OutboundIQ for Edge runtime\n * Call this once at the start of your edge function\n */\nexport function initEdge(config?: Partial<OutboundIQConfig>): void {\n  if (isInitialized) return;\n\n  const apiKey = config?.apiKey || process.env.OUTBOUNDIQ_API_KEY;\n\n  if (!apiKey) {\n    console.warn('[OutboundIQ] Missing API key for edge runtime');\n    return;\n  }\n\n  init({\n    apiKey,\n    endpoint: config?.endpoint || process.env.OUTBOUNDIQ_ENDPOINT,\n    debug: config?.debug || process.env.OUTBOUNDIQ_DEBUG === 'true',\n    // Smaller batches for edge (short-lived)\n    batchSize: config?.batchSize || 5,\n    flushInterval: config?.flushInterval || 1000,\n    ...config,\n  });\n\n  isInitialized = true;\n}\n\n/**\n * Track a fetch request manually\n * Auto-initializes SDK if not already done\n */\nexport async function trackFetch(\n  input: RequestInfo | URL,\n  init?: RequestInit & { userContext?: UserContext }\n): Promise<Response> {\n  // Auto-initialize if needed\n  const initialized = ensureInitialized();\n  \n  const startTime = performance.now();\n  const url = typeof input === 'string' ? input : input instanceof URL ? input.toString() : input.url;\n  const method = init?.method || 'GET';\n  const userContext = init?.userContext;\n\n  // Remove our custom property before passing to fetch\n  const fetchInit = init ? { ...init } : undefined;\n  if (fetchInit) {\n    delete (fetchInit as any).userContext;\n  }\n\n  try {\n    const response = await fetch(input, fetchInit);\n    const duration = performance.now() - startTime;\n\n    // Track the call if initialized\n    if (initialized) {\n      track({\n        method: method.toUpperCase(),\n        url,\n        statusCode: response.status,\n        duration,\n        userContext: userContext || null,\n      });\n      \n      // Flush immediately for serverless (request may end soon)\n      await coreFlush();\n    }\n\n    return response;\n  } catch (error) {\n    const duration = performance.now() - startTime;\n\n    if (initialized) {\n      track({\n        method: method.toUpperCase(),\n        url,\n        statusCode: 0,\n        duration,\n        error: error instanceof Error ? error.message : 'Unknown error',\n        userContext: userContext || null,\n      });\n      \n      await coreFlush();\n    }\n\n    throw error;\n  }\n}\n\n/**\n * Create a tracked fetch function with pre-configured user context\n */\nexport function createTrackedFetch(userContext: UserContext) {\n  return async function trackedFetch(\n    input: RequestInfo | URL,\n    init?: RequestInit\n  ): Promise<Response> {\n    return trackFetch(input, { ...init, userContext });\n  };\n}\n\n// Re-export useful functions\nexport { track, flush, setUserContext } from '@outboundiq/core';\nexport type { UserContext } from '@outboundiq/core';\n\n// ============================================\n// SDK Methods: recommend, providerStatus, endpointStatus\n// ============================================\n\n/**\n * Common options for SDK methods\n */\ninterface SdkMethodOptions {\n  userContext?: UserContext;\n  requestId?: string;\n}\n\n/**\n * Recommendation response from the API\n */\ninterface RecommendResponse {\n  success: boolean;\n  service?: {\n    name: string;\n    description: string;\n    strategy: string;\n  };\n  recommendation?: {\n    provider: string;\n    endpoint: string;\n    confidence: number;\n    reason: string;\n  };\n  alternatives?: Array<{\n    provider: string;\n    endpoint: string;\n    confidence: number;\n  }>;\n  error?: string;\n}\n\n/**\n * Provider status response from the API\n */\ninterface ProviderStatusResponse {\n  success: boolean;\n  provider?: {\n    name: string;\n    slug: string;\n    status: string;\n    description: string;\n  };\n  metrics?: {\n    success_rate: number;\n    average_latency: number;\n    total_requests: number;\n  };\n  incidents?: Array<{\n    title: string;\n    status: string;\n    created_at: string;\n  }>;\n  error?: string;\n}\n\n/**\n * Endpoint status response from the API\n */\ninterface EndpointStatusResponse {\n  success: boolean;\n  endpoint?: {\n    name: string;\n    slug: string;\n    method: string;\n    url_pattern: string;\n  };\n  metrics?: {\n    success_rate: number;\n    average_latency: number;\n    total_requests: number;\n  };\n  provider?: {\n    name: string;\n    status: string;\n  };\n  error?: string;\n}\n\n/**\n * Get the base API URL from environment\n */\nfunction getBaseUrl(): string {\n  // Use the main API, not the metric endpoint\n  const endpoint = process.env.OUTBOUNDIQ_ENDPOINT || 'https://agent.outboundiq.dev/api/metric';\n  // Convert metric endpoint to base API URL\n  // https://agent.outboundiq.dev/api/metric â†’ https://agent.outboundiq.dev/api\n  return endpoint.replace('/metric', '');\n}\n\n/**\n * Get recommendation for a service\n * \n * Returns the best provider/endpoint to use based on:\n * - Your actual API usage data (success rate, latency, stability)\n * - Provider status page health\n * - Recent incidents\n * \n * @example\n * ```typescript\n * const result = await recommend('payment-processing');\n * if (result?.success && result.recommendation) {\n *   console.log(`Use ${result.recommendation.provider} (${result.recommendation.confidence}% confidence)`);\n * }\n * ```\n */\nexport async function recommend(\n  serviceName: string,\n  options: SdkMethodOptions = {}\n): Promise<RecommendResponse | null> {\n  const apiKey = process.env.OUTBOUNDIQ_API_KEY;\n  if (!apiKey) {\n    console.warn('[OutboundIQ] Missing API key for recommend()');\n    return null;\n  }\n\n  try {\n    const url = `${getBaseUrl()}/v1/recommend/${encodeURIComponent(serviceName)}`;\n    const requestId = options.requestId || crypto.randomUUID();\n\n    const headers: Record<string, string> = {\n      'Authorization': `Bearer ${apiKey}`,\n      'Accept': 'application/json',\n      'X-Request-Id': requestId,\n    };\n\n    if (options.userContext) {\n      headers['X-User-Context'] = JSON.stringify(options.userContext);\n    }\n\n    const response = await fetch(url, {\n      method: 'GET',\n      headers,\n    });\n\n    return await response.json();\n  } catch (error) {\n    console.error('[OutboundIQ] recommend() failed:', error);\n    return null;\n  }\n}\n\n/**\n * Get status and metrics for a provider\n * \n * Returns real-time actionable data for decision-making:\n * - Provider status (from status page)\n * - Aggregate metrics (success rate, latency)\n * - Active incidents\n * \n * @example\n * ```typescript\n * const status = await providerStatus('stripe');\n * if (status?.provider?.status === 'operational') {\n *   // Safe to use Stripe\n * }\n * ```\n */\nexport async function providerStatus(\n  providerSlug: string,\n  options: SdkMethodOptions = {}\n): Promise<ProviderStatusResponse | null> {\n  const apiKey = process.env.OUTBOUNDIQ_API_KEY;\n  if (!apiKey) {\n    console.warn('[OutboundIQ] Missing API key for providerStatus()');\n    return null;\n  }\n\n  try {\n    const url = `${getBaseUrl()}/v1/provider/${encodeURIComponent(providerSlug)}/status`;\n\n    const headers: Record<string, string> = {\n      'Authorization': `Bearer ${apiKey}`,\n      'Accept': 'application/json',\n    };\n\n    if (options.userContext) {\n      headers['X-User-Context'] = JSON.stringify(options.userContext);\n    }\n\n    const response = await fetch(url, {\n      method: 'GET',\n      headers,\n    });\n\n    return await response.json();\n  } catch (error) {\n    console.error('[OutboundIQ] providerStatus() failed:', error);\n    return null;\n  }\n}\n\n/**\n * Get status and metrics for a specific endpoint\n * \n * Returns real-time actionable data for decision-making:\n * - Endpoint-specific metrics (success rate, latency)\n * - Provider status\n * - Active incidents\n * \n * @example\n * ```typescript\n * const status = await endpointStatus('stripe-post-charges');\n * if (status?.metrics?.success_rate > 99) {\n *   // Endpoint is healthy\n * }\n * ```\n */\nexport async function endpointStatus(\n  endpointSlug: string,\n  options: SdkMethodOptions = {}\n): Promise<EndpointStatusResponse | null> {\n  const apiKey = process.env.OUTBOUNDIQ_API_KEY;\n  if (!apiKey) {\n    console.warn('[OutboundIQ] Missing API key for endpointStatus()');\n    return null;\n  }\n\n  try {\n    const url = `${getBaseUrl()}/v1/endpoint/${encodeURIComponent(endpointSlug)}/status`;\n\n    const headers: Record<string, string> = {\n      'Authorization': `Bearer ${apiKey}`,\n      'Accept': 'application/json',\n    };\n\n    if (options.userContext) {\n      headers['X-User-Context'] = JSON.stringify(options.userContext);\n    }\n\n    const response = await fetch(url, {\n      method: 'GET',\n      headers,\n    });\n\n    return await response.json();\n  } catch (error) {\n    console.error('[OutboundIQ] endpointStatus() failed:', error);\n    return null;\n  }\n}\n\n/**\n * Axios interceptor types\n */\ninterface AxiosResponse {\n  status: number;\n  config: {\n    url?: string;\n    method?: string;\n    baseURL?: string;\n    headers?: Record<string, string>;\n    data?: unknown;\n    metadata?: { startTime: number };\n  };\n  headers?: Record<string, string>;\n  data?: unknown;\n}\n\ninterface AxiosError {\n  config?: AxiosResponse['config'];\n  response?: AxiosResponse;\n  message: string;\n}\n\ninterface AxiosInstance {\n  interceptors: {\n    request: {\n      use: (\n        onFulfilled?: (config: any) => any,\n        onRejected?: (error: any) => any\n      ) => number;\n    };\n    response: {\n      use: (\n        onFulfilled?: (response: any) => any,\n        onRejected?: (error: any) => any\n      ) => number;\n    };\n  };\n  \n  get: <T = any>(url: string, config?: any) => Promise<{ data: T; status: number; headers: any; config: any }>;\n  post: <T = any>(url: string, data?: any, config?: any) => Promise<{ data: T; status: number; headers: any; config: any }>;\n  put: <T = any>(url: string, data?: any, config?: any) => Promise<{ data: T; status: number; headers: any; config: any }>;\n  patch: <T = any>(url: string, data?: any, config?: any) => Promise<{ data: T; status: number; headers: any; config: any }>;\n  delete: <T = any>(url: string, config?: any) => Promise<{ data: T; status: number; headers: any; config: any }>;\n  head: <T = any>(url: string, config?: any) => Promise<{ data: T; status: number; headers: any; config: any }>;\n  options: <T = any>(url: string, config?: any) => Promise<{ data: T; status: number; headers: any; config: any }>;\n  request: <T = any>(config: any) => Promise<{ data: T; status: number; headers: any; config: any }>;\n  // Instance properties\n  defaults: any;\n}\n\n/**\n * Add OutboundIQ tracking to an existing axios instance\n * \n * This adds interceptors without removing existing ones.\n * Works with any axios instance that already has interceptors.\n * \n * @example\n * ```typescript\n * import axios from 'axios';\n * import { addAxiosTracking } from '@outboundiq/nextjs/edge';\n * \n * // Your existing axios instance with interceptors\n * const api = axios.create({ baseURL: 'https://api.example.com' });\n * api.interceptors.request.use(config => {\n *   config.headers.Authorization = `Bearer ${token}`;\n *   return config;\n * });\n * \n * // Add OutboundIQ tracking (doesn't remove existing interceptors)\n * addAxiosTracking(api);\n * \n * // Now all calls are tracked!\n * await api.get('/users');\n * ```\n */\nexport function addAxiosTracking(\n  axiosInstance: AxiosInstance,\n  options?: { userContext?: UserContext }\n): void {\n  // Ensure SDK is initialized\n  ensureInitialized();\n\n  // Request interceptor - record start time\n  axiosInstance.interceptors.request.use(\n    (config: any) => {\n      config.metadata = { startTime: performance.now() };\n      return config;\n    },\n    (error: any) => Promise.reject(error)\n  );\n\n  // Response interceptor - track successful calls\n  axiosInstance.interceptors.response.use(\n    async (response: AxiosResponse) => {\n      const duration = response.config.metadata?.startTime\n        ? performance.now() - response.config.metadata.startTime\n        : 0;\n\n      const url = buildAxiosUrl(response.config);\n\n      track({\n        method: (response.config.method || 'GET').toUpperCase(),\n        url,\n        statusCode: response.status,\n        duration,\n        userContext: options?.userContext || null,\n      });\n\n      // Flush for serverless\n      await coreFlush();\n\n      return response;\n    },\n    async (error: AxiosError) => {\n      const duration = error.config?.metadata?.startTime\n        ? performance.now() - error.config.metadata.startTime\n        : 0;\n\n      const url = error.config ? buildAxiosUrl(error.config) : 'unknown';\n\n      track({\n        method: (error.config?.method || 'GET').toUpperCase(),\n        url,\n        statusCode: error.response?.status || 0,\n        duration,\n        error: error.message,\n        userContext: options?.userContext || null,\n      });\n\n      await coreFlush();\n\n      return Promise.reject(error);\n    }\n  );\n}\n\n/**\n * Build full URL from axios config\n */\nfunction buildAxiosUrl(config: AxiosResponse['config']): string {\n  const baseURL = config.baseURL || '';\n  const url = config.url || '';\n  \n  if (url.startsWith('http://') || url.startsWith('https://')) {\n    return url;\n  }\n  \n  return baseURL + url;\n}\n\n/**\n * Create a tracked axios instance\n * \n * @example\n * ```typescript\n * import axios from 'axios';\n * import { createTrackedAxios } from '@outboundiq/nextjs/edge';\n * \n * const api = createTrackedAxios(axios, {\n *   baseURL: 'https://api.example.com',\n * });\n * \n * await api.get('/users'); // Automatically tracked!\n * ```\n */\nexport function createTrackedAxios(\n  axios: { create: (config?: any) => AxiosInstance },\n  config?: any,\n  options?: { userContext?: UserContext }\n): AxiosInstance {\n  const instance = axios.create(config);\n  addAxiosTracking(instance, options);\n  return instance;\n}\n\n","/**\n * @outboundiq/nextjs\n * \n * OutboundIQ SDK for Next.js - Automatic tracking of all outbound API calls\n * \n * ## Quick Start\n * \n * 1. Install the package:\n * ```bash\n * npm install @outboundiq/nextjs\n * ```\n * \n * 2. Add environment variables:\n * ```env\n * OUTBOUNDIQ_API_KEY=your-api-key\n * OUTBOUNDIQ_PROJECT_ID=your-project-id\n * ```\n * \n * 3. Create instrumentation.ts in your project root:\n * ```typescript\n * export async function register() {\n *   if (process.env.NEXT_RUNTIME === 'nodejs') {\n *     await import('@outboundiq/nextjs/register');\n *   }\n * }\n * ```\n * \n * 4. (Optional) Add middleware for user context:\n * ```typescript\n * // middleware.ts\n * import { withOutboundIQ } from '@outboundiq/nextjs/middleware';\n * \n * export default withOutboundIQ(async (request) => {\n *   return NextResponse.next();\n * });\n * ```\n * \n * That's it! All outbound API calls are now automatically tracked.\n * \n * @packageDocumentation\n */\n\n// Re-export core client functionality\nexport {\n  init,\n  getClient,\n  track,\n  setUserContext,\n  flush,\n  shutdown,\n  type OutboundIQConfig,\n  type UserContext,\n  type ApiCall,\n} from '@outboundiq/core';\n\n// Re-export node patching (for manual patching if needed)\nexport {\n  patchNodeHttp,\n  unpatchNodeHttp,\n  setUserContextResolver,\n} from '@outboundiq/core/node';\n\n// Export context utilities\nexport {\n  runWithContext,\n  getRequestContext,\n  getCurrentUserContext,\n  setCurrentUserContext,\n  createRequestContext,\n  type RequestContext,\n} from './context/request-context';\n\n// Export middleware utilities\nexport {\n  withOutboundIQ,\n  getUserContextFromRequest,\n  createOutboundIQMiddleware,\n  USER_CONTEXT_HEADER,\n  type WithOutboundIQOptions,\n} from './middleware';\n\n// Export edge utilities (also work in Node.js runtime)\nexport {\n  initEdge,\n  trackFetch,\n  createTrackedFetch,\n  addAxiosTracking,\n  createTrackedAxios,\n  // SDK methods\n  recommend,\n  providerStatus,\n  endpointStatus,\n} from './edge';\n\n/**\n * Helper to wrap API route handlers with user context\n */\nexport function withUserContext<T extends (...args: any[]) => any>(\n  handler: T,\n  userContext: import('@outboundiq/core').UserContext\n): T {\n  return (async (...args: Parameters<T>) => {\n    const { setUserContext } = await import('@outboundiq/core');\n    setUserContext(userContext);\n    try {\n      return await handler(...args);\n    } finally {\n      setUserContext(null);\n    }\n  }) as T;\n}\n\n"]}