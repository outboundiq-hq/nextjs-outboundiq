{"version":3,"sources":["../src/context/request-context.ts","../src/register.ts"],"names":["AsyncLocalStorage","init","setUserContextResolver","registerNode","getClient"],"mappings":";;;;;;;AAoCA,IAAM,qBAAA,GAAwB,IAAIA,6BAAA,EAAkC;AAe7D,SAAS,iBAAA,GAAgD;AAC9D,EAAA,OAAO,sBAAsB,QAAA,EAAS;AACxC;AAKO,SAAS,qBAAA,GAA4C;AAC1D,EAAA,MAAM,UAAU,iBAAA,EAAkB;AAClC,EAAA,OAAO,SAAS,WAAA,IAAe,IAAA;AACjC;AAKO,SAAS,sBAAsB,WAAA,EAAuC;AAC3E,EAAA,MAAM,UAAU,iBAAA,EAAkB;AAClC,EAAA,IAAI,OAAA,EAAS;AACX,IAAA,OAAA,CAAQ,WAAA,GAAc,WAAA;AAAA,EACxB;AACF;;;AC/CA,IAAM,MAAA,GAAS,QAAQ,GAAA,CAAI,cAAA;AAE3B,IAAI,CAAC,MAAA,EAAQ;AACX,EAAA,OAAA,CAAQ,IAAA;AAAA,IACN;AAAA,GAEF;AACF,CAAA,MAAO;AAGL,EAAAC,SAAA,CAAK;AAAA,IACH,MAAA;AAAA,IACA,QAAA,EAAU,QAAQ,GAAA,CAAI,mBAAA;AAAA,IACtB,KAAA,EAAO,OAAA,CAAQ,GAAA,CAAI,gBAAA,KAAqB,MAAA;AAAA,IACxC,WAAW,QAAA,CAAS,OAAA,CAAQ,GAAA,CAAI,qBAAA,IAAyB,MAAM,EAAE,CAAA;AAAA,IACjE,eAAe,QAAA,CAAS,OAAA,CAAQ,GAAA,CAAI,yBAAA,IAA6B,QAAQ,EAAE;AAAA,GAC5E,CAAA;AAGD,EAAAC,2BAAA,CAAuB,MAAM,uBAAuB,CAAA;AAGpD,EAAAC,aAAA,EAAa;AAEb,EAAA,OAAA,CAAQ,IAAI,uCAAuC,CAAA;AAGnD,EAAA,MAAM,WAAW,YAAY;AAC3B,IAAA,MAAM,SAASC,cAAA,EAAU;AACzB,IAAA,IAAI,MAAA,EAAQ;AACV,MAAA,OAAA,CAAQ,IAAI,+BAA+B,CAAA;AAC3C,MAAA,MAAM,OAAO,QAAA,EAAS;AAAA,IACxB;AAAA,EACF,CAAA;AAEA,EAAA,OAAA,CAAQ,EAAA,CAAG,WAAW,QAAQ,CAAA;AAC9B,EAAA,OAAA,CAAQ,EAAA,CAAG,UAAU,QAAQ,CAAA;AAC/B","file":"register.js","sourcesContent":["/**\n * Request context using AsyncLocalStorage\n * \n * This allows us to track user context across the entire request lifecycle,\n * similar to how Laravel uses request context for Auth::user().\n */\n\nimport { AsyncLocalStorage } from 'async_hooks';\nimport type { UserContext } from '@outboundiq/core';\n\n/**\n * Request context stored for each request\n */\nexport interface RequestContext {\n  /**\n   * User context for this request\n   */\n  userContext: UserContext | null;\n\n  /**\n   * Request ID for tracing\n   */\n  requestId: string;\n\n  /**\n   * Request start time\n   */\n  startTime: number;\n\n  /**\n   * Additional metadata\n   */\n  metadata?: Record<string, unknown>;\n}\n\n// Create the AsyncLocalStorage instance\nconst requestContextStorage = new AsyncLocalStorage<RequestContext>();\n\n/**\n * Run a function with request context\n */\nexport function runWithContext<T>(\n  context: RequestContext,\n  fn: () => T\n): T {\n  return requestContextStorage.run(context, fn);\n}\n\n/**\n * Get the current request context\n */\nexport function getRequestContext(): RequestContext | undefined {\n  return requestContextStorage.getStore();\n}\n\n/**\n * Get the current user context\n */\nexport function getCurrentUserContext(): UserContext | null {\n  const context = getRequestContext();\n  return context?.userContext ?? null;\n}\n\n/**\n * Set user context for the current request\n */\nexport function setCurrentUserContext(userContext: UserContext | null): void {\n  const context = getRequestContext();\n  if (context) {\n    context.userContext = userContext;\n  }\n}\n\n/**\n * Generate a request ID\n */\nexport function generateRequestId(): string {\n  return `req_${Date.now().toString(36)}_${Math.random().toString(36).substring(2, 9)}`;\n}\n\n/**\n * Create a new request context\n */\nexport function createRequestContext(\n  userContext: UserContext | null = null,\n  metadata?: Record<string, unknown>\n): RequestContext {\n  return {\n    userContext,\n    requestId: generateRequestId(),\n    startTime: Date.now(),\n    metadata,\n  };\n}\n\n","/**\n * @outboundiq/nextjs/register\n * \n * Auto-registration for Next.js instrumentation.ts\n * \n * This is the main entry point for Next.js applications.\n * Import this in your instrumentation.ts file:\n * \n * @example\n * ```typescript\n * // instrumentation.ts\n * export async function register() {\n *   if (process.env.NEXT_RUNTIME === 'nodejs') {\n *     await import('@outboundiq/nextjs/register');\n *   }\n * }\n * ```\n */\n\nimport { init, getClient, setUserContext } from '@outboundiq/core';\nimport { register as registerNode, setUserContextResolver } from '@outboundiq/core/node';\nimport { getCurrentUserContext } from './context/request-context';\n\n// Get config from environment\nconst apiKey = process.env.OUTBOUNDIQ_KEY;\n\nif (!apiKey) {\n  console.warn(\n    '[OutboundIQ] Missing OUTBOUNDIQ_KEY environment variable. ' +\n    'Tracking will be disabled.'\n  );\n} else {\n  // Initialize the client\n  // Note: projectId is determined from API key on the backend\n  init({\n    apiKey,\n    endpoint: process.env.OUTBOUNDIQ_ENDPOINT,\n    debug: process.env.OUTBOUNDIQ_DEBUG === 'true',\n    batchSize: parseInt(process.env.OUTBOUNDIQ_BATCH_SIZE || '10', 10),\n    flushInterval: parseInt(process.env.OUTBOUNDIQ_FLUSH_INTERVAL || '5000', 10),\n  });\n\n  // Set up user context resolver to use AsyncLocalStorage\n  setUserContextResolver(() => getCurrentUserContext());\n\n  // Patch http/https and fetch\n  registerNode();\n\n  console.log('[OutboundIQ] Next.js tracking enabled');\n\n  // Handle graceful shutdown\n  const shutdown = async () => {\n    const client = getClient();\n    if (client) {\n      console.log('[OutboundIQ] Shutting down...');\n      await client.shutdown();\n    }\n  };\n\n  process.on('SIGTERM', shutdown);\n  process.on('SIGINT', shutdown);\n}\n\nexport { getCurrentUserContext, setCurrentUserContext } from './context/request-context';\n\n"]}